# Технічне Завдання: Інтеграція FoodOK ↔ Tabletki.ua

**Дата створення:** 12 січня 2026  
**Версія:** 1.0 (Фінальна після уточнень)  
**Статус:** Готово до розробки  

---

## 📋 1. УТОЧНЕНА ПОСТАНОВКА ЗАВДАННЯ

### 1.1. МЕТА ПРОЄКТУ

Створити автоматизовану двосторонню інтеграцію між: 
- **FoodOK** (Odoo ERP) - управління замовленнями та складом
- **Tabletki.ua** - онлайн аптека (торговий майданчик)

через платформу **n8n** (вже розгорнута на https://n8n.quickdo.it.com/)

---

### 1.2. SCOPE (ЩО РОБИМО)

#### 4 workflows для MVP:

```
1. 📦 CATALOG SYNC (Одоо → Таблетки)
   Щодня синхронізувати каталог товарів
   
2. 📊 STOCK SYNC (Одоо → Таблетки)  
   Кожні 5 хв оновлювати залишки та ціни
   
3. 🛒 BOOKING FLOW (Таблетки → Одоо → Таблетки)
   Кожні 5 хв обробляти нові замовлення + TTN
   
4. 🔄 STATUS SYNC (Таблетки → Одоо)
   Кожні 5 хв синхронізувати статуси та скасування
```

---

### 1.3. ТЕХНІЧНЕ СЕРЕДОВИЩЕ

#### Існуюча інфраструктура:

```yaml
n8n:
  version: "1.123.4"
  url: "https://n8n.quickdo.it.com/"
  uptime: "4 тижні без збоїв"
  existing_workflows: 11 (деякі частково реалізовані)
  
odoo:
  url: "https://test.foodok-17ce.odoo.systems"
  auth: "JSON-RPC"
  credentials: "Odoo account (rk2XVyGzAoWlkmEg)"
  
tabletki:
  import_api: "https://testenv-import.tabletki.ua"
  orders_api: "https://testenv-reserve.tabletki.ua"
  auth: "Basic Auth (dU1Xb55U6IzOlAwM)"
  supplier_id: "30638"
  
notifications:
  email: "o.ryhun@quickdo.it.com"
  smtp: "Gmail OAuth2 (oGIDr2s7otQ5m80Z)"
```

---

### 1.4. ДЕТАЛЬНА СПЕЦИФІКАЦІЯ WORKFLOWS

---

#### WORKFLOW 1: CATALOG SYNC 📦

**Назва:** `FoodOK_Tabletki_Catalog_Daily_Sync`

**Тригер:** Schedule (щодня о 03:00)

**Логіка:**

```
┌─────────────────────────────────────────────────────────────┐
│ 1. Schedule Trigger (daily 03:00)                          │
└────────────────┬────────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────────┐
│ 2. Odoo: GET product.product                                │
│    Fields: id, name, barcode, taxes_id, dr_brand_value_id   │
│    Filter: dr_brand_value_id NOT NULL                      │
│            additional_product_tag_ids = 'tabletki'          │
└────────────────┬────────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────────┐
│ 3. Code Node: Transform Data                                │
│    - Map taxes_id → VAT (34→20%, 35→7%, 36→0%)            │
│    - Extract Producer from dr_brand_value_id[1]             │
│    - Validate required fields (id, name, barcode, VAT)      │
│    - Build Offers array                                     │
└────────────────┬────────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────────┐
│ 4. Code Node: Add Suppliers                                 │
│    Add Suppliers array with Barcode supplier                │
└────────────────┬────────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────────┐
│ 5. HTTP Request: POST to Tabletki Import API               │
│    URL: /Import/Ref/30638                                   │
│    Body: { Offers: [...], Suppliers: [...] }               │
└────────────────┬────────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────────┐
│ 6. IF Node: Check Response                                  │
│    IsError == false && IsSupplierError == false            │
└─────┬──────────────────────────────┬────────────────────────┘
      │ true                         │ false
┌─────▼────────┐              ┌──────▼─────────────────────┐
│ 7a. Success  │              │ 7b. Send Error Email        │
│   (log only) │              │     To: o.ryhun@...          │
└──────────────┘              │     Subject: Catalog Failed │
                              └─────────────────────────────┘
```

**Мапінг полів:**

| Odoo field | Transform | Tabletki field |
|------------|-----------|----------------|
| `id` | String | `Code` |
| `name` | as-is | `Name` |
| `dr_brand_value_id[1]` | extract | `Producer` |
| `taxes_id[0]` | map via dict | `VAT` |
| `barcode` | as-is | `SupplierCodes[].Code` |

**Error handling:**
- ✅ Invalid JSON → Email
- ✅ IsError=true → Email
- ✅ IsSupplierError=true → Email
- ✅ Missing required fields → Skip product

---

#### WORKFLOW 2: STOCK SYNC 📊

**Назва:** `FoodOK_Tabletki_Stock_Every5Min_Sync`

**Тригер:** Schedule (кожні 5 хвилин)

**Логіка:**

```
┌──────────────────────────────────────────────────────────┐
│ 1. Schedule Trigger (every 5 min)                       │
└────────────────┬─────────────────────────────────────────┘
                 │
┌────────────────▼─────────────────────────────────────────┐
│ 2. Odoo: GET stock.quant (on-hand quantities)           │
│    Fields: product_id, quantity, location_id            │
│    Filter: location_id = warehouse location             │
│            product_id.additional_product_tag_ids =      │
│            'tabletki'                                   │
└────────────────┬─────────────────────────────────────────┘
                 │
┌────────────────▼─────────────────────────────────────────┐
│ 3. Odoo: GET product.product (for price + mapping)      │
│    Fields: id, list_price, barcode                      │
│    IDs: from step 2 product_ids                         │
└────────────────┬─────────────────────────────────────────┘
                 │
┌────────────────▼─────────────────────────────────────────┐
│ 4. Code Node: Merge & Transform                         │
│    - Join quantity + price by product_id                │
│    - Build StockPrices array:                            │
│      {Code, Quantity, Price, SupplierCode}              │
└────────────────┬─────────────────────────────────────────┘
                 │
┌────────────────▼─────────────────────────────────────────┐
│ 5. HTTP Request: POST to Tabletki Import API            │
│    URL: /Import/RefStockPrice/30638                     │
│    Body: { StockPrices: [...] }                         │
└────────────────┬─────────────────────────────────────────┘
                 │
┌────────────────▼─────────────────────────────────────────┐
│ 6. IF Node: Check Response                               │
│    IsError == false                                      │
└─────┬───────────────────────┬────────────────────────────┘
      │ true                  │ false
┌─────▼──────┐         ┌──────▼──────────────────────────┐
│ 7a. Success│         │ 7b. Send Error Email             │
└────────────┘         └──────────────────────────────────┘
```

**Мапінг полів:**

| Odoo field | Tabletki field |
|------------|----------------|
| `product_id.id` | `Code` |
| `quantity` | `Quantity` |
| `product_id.list_price` | `Price` |
| `product_id.barcode` | `SupplierCode` |

---

#### WORKFLOW 3: BOOKING FLOW 🛒

**Назва:** `FoodOK_Tabletki_Booking_Bidirectional`

**Тригер:** Schedule (кожні 5 хвилин)

**Логіка (2 паралельних flow):**

**Flow A: Нові замовлення (Tabletki → Odoo)**

```
┌──────────────────────────────────────────────────────────┐
│ 1. Schedule Trigger (every 5 min)                       │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│ 2. HTTP GET: Tabletki New Orders                        │
│    URL: /api/Orders/{supplier_id}/0                     │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│ 3. IF: Has new orders? (array length > 0)               │
└──┬───────────────────────────────────────────────────────┘
   │ true
┌──▼───────────────────────────────────────────────────────┐
│ 4. Loop over orders (Split in Batches node)             │
└──┬───────────────────────────────────────────────────────┘
   │
┌──▼───────────────────────────────────────────────────────┐
│ 5. Code Node: Transform Order                           │
│    Tabletki → Odoo sale.order structure                 │
└──┬───────────────────────────────────────────────────────┘
   │
┌──▼───────────────────────────────────────────────────────┐
│ 6. Odoo: CREATE sale.order                              │
│    Store Tabletki order_id in origin field              │
└──┬───────────────────────────────────────────────────────┘
   │
┌──▼───────────────────────────────────────────────────────┐
│ 7. HTTP POST: Accept Order in Tabletki                  │
│    URL: /api/Orders/acceptedOrder/{supplier_id}         │
└──┬───────────────────────────────────────────────────────┘
   │
┌──▼───────────────────────────────────────────────────────┐
│ 8. Error Handler: IF failed → Email notification        │
└───────────────────────────────────────────────────────────┘
```

**Flow B: Відправка TTN (Odoo → Tabletki)**

```
┌──────────────────────────────────────────────────────────┐
│ 1. Schedule Trigger (same, every 5 min)                 │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│ 2. Odoo: GET sale.order                                 │
│    Filter: tag_ids IN [19]  # ready for delivery        │
│            kw_np_tracking_document_name != false         │
│            origin != false  # has Tabletki order ID     │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│ 3. Code Node: Build TTN payload                         │
│    [{id: origin, ttn: kw_np_tracking_document_name}]    │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│ 4. HTTP POST: Send TTN to Tabletki                      │
│    URL: /api/Orders/ttnForOrder                         │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│ 5. Error Handler: IF failed → Email                     │
└───────────────────────────────────────────────────────────┘
```

---

#### WORKFLOW 4: STATUS SYNC 🔄

**Назва:** `FoodOK_Tabletki_Status_Cancellations_Sync`

**Тригер:** Schedule (кожні 5 хвилин)

**Логіка:**

```
┌──────────────────────────────────────────────────────────┐
│ 1. Schedule Trigger (every 5 min)                       │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│ 2. HTTP GET: Tabletki Cancelled Orders                  │
│    URL: /api/Orders/cancelledOrdersByCustomer/30639     │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│ 3. IF: Has cancellations? (array length > 0)            │
└──┬───────────────────────────────────────────────────────┘
   │ true
┌──▼───────────────────────────────────────────────────────┐
│ 4. Loop over cancelled orders                           │
└──┬───────────────────────────────────────────────────────┘
   │
┌──▼───────────────────────────────────────────────────────┐
│ 5. Odoo: SEARCH sale.order by origin (Tabletki ID)      │
└──┬───────────────────────────────────────────────────────┘
   │
┌──▼───────────────────────────────────────────────────────┐
│ 6. Odoo: UPDATE sale.order → state = 'cancel'           │
└──┬───────────────────────────────────────────────────────┘
   │
┌──▼───────────────────────────────────────────────────────┐
│ 7. HTTP POST: Confirm cancellation in Tabletki          │
│    URL: /api/Orders/acceptedCanceledOrdersByCustomer    │
└──┬───────────────────────────────────────────────────────┘
   │
┌──▼───────────────────────────────────────────────────────┐
│ 8. Error Handler: IF failed → Email                     │
└───────────────────────────────────────────────────────────┘
```

---

### 1.5. КРИТЕРІЇ ПРИЙМАННЯ

#### Функціональні:
- ✅ Catalog sync відправляє всі активні товари з Одоо в Таблетки
- ✅ Stock sync оновлює залишки та ціни кожні 5 хвилин
- ✅ Нові замовлення з Tabletki автоматично створюються в Одоо
- ✅ TTN з Одоо автоматично відправляється в Таблетки
- ✅ Скасування з Tabletki синхронізуються в Одоо

#### Нефункціональні:
- ✅ Email сповіщення при помилках
- ✅ Логування всіх операцій в n8n execution history
- ✅ Workflows активні та працюють по розкладу
- ✅ Документація (README) з описом кожного workflow

#### Технічні:
- ✅ Використання існуючих credentials
- ✅ Error handling в кожному workflow
- ✅ Валідація даних перед відправкою
- ✅ Idempotent операції (можна запускати повторно безпечно)

---

### 1.6. OUT OF SCOPE (ЩО НЕ РОБИМО)

❌ Автоматичне створення нових продуктів  
❌ Складна логіка розрахунку цін (discount, promotion)  
❌ Інтеграція з іншими системами (крім Odoo + Tabletki)  
❌ UI для керування інтеграцією  
❌ Real-time webhooks (тільки polling по schedule)  
❌ Історія змін / аудит лог  
❌ Масове редагування через n8n  
❌ DevOps автоматизація (backup/restore скрипти)

---

## 📊 2. ОЦІНКА ЧАСУ НА ВИКОНАННЯ

### 2.1. BREAKDOWN ПО WORKFLOWS

| Workflow | Задачі | Оптиміст | Реаліст | Песиміст |
|----------|--------|----------|---------|----------|
| **1. Catalog Sync** | - Odoo GET products<br>- Transform + VAT mapping<br>- Tabletki POST<br>- Error handling<br>- Testing | 6 год | 10 год | 14 год |
| **2. Stock Sync** | - Odoo GET stock.quant<br>- Odoo GET products<br>- Merge data<br>- Tabletki POST<br>- Error handling<br>- Testing | 6 год | 10 год | 14 год |
| **3. Booking Flow** | - Tabletki GET orders<br>- Transform to Odoo<br>- Odoo CREATE sale.order<br>- Tabletki accept<br>- TTN flow (Odoo→Tabletki)<br>- Error handling<br>- Testing | 10 год | 16 год | 22 год |
| **4. Status Sync** | - Tabletki GET cancellations<br>- Odoo SEARCH + UPDATE<br>- Tabletki confirm<br>- Error handling<br>- Testing | 5 год | 8 год | 12 год |
| **Documentation** | - README для кожного workflow<br>- Deployment інструкції<br>- Troubleshooting guide | 3 год | 5 год | 7 год |
| **Integration Testing** | - End-to-end тестування<br>- Bug fixing<br>- Performance tuning | 5 год | 8 год | 12 год |
| **Deployment & QA** | - Активація workflows<br>- Моніторинг 1-2 дні<br>- Final adjustments | 3 год | 6 год | 9 год |

---

### 2.2. TOTAL ESTIMATE

```
┌──────────────────┬──────────────┬──────────────┬──────────────┐
│   СЦЕНАРІЙ       │ ОПТИМІСТ     │ РЕАЛІСТ      │ ПЕСИМІСТ     │
├──────────────────┼──────────────┼──────────────┼──────────────┤
│ Development      │   38 год     │   63 год     │   90 год     │
├──────────────────┼──────────────┼──────────────┼──────────────┤
│ Робочих днів     │   4.8 дні    │   7.9 дні    │  11.3 дні    │
│ (8-год день)     │              │              │              │
├──────────────────┼──────────────┼──────────────┼──────────────┤
│ Календарних днів │   ~7 днів    │  ~12 днів    │  ~17 днів    │
│ (з буфером)      │              │              │              │
├──────────────────┼──────────────┼──────────────┼──────────────┤
│ Delivery Date    │ 19 січня     │ 24 січня     │ 29 січня     │
│ (від 13 січня)   │              │              │              │
└──────────────────┴──────────────┴──────────────┴──────────────┘
```

---

### 2.3. РЕКОМЕНДОВАНА ОЦІНКА

```
╔══════════════════════════════════════════════════════════╗
║  РЕАЛІСТИЧНА ОЦІНКА: 8 робочих днів (63 години)         ║
║                                                          ║
║  Start:  13 січня 2026                                   ║
║  Finish: 24 січня 2026                                   ║
║                                                          ║
║  Confidence: 75%                                         ║
╚══════════════════════════════════════════════════════════╝
```

**Чому 63 години реалістично:**
- ✅ Інфраструктура готова (n8n працює, credentials налаштовані)
- ✅ Є існуючі workflows як starting point
- ✅ API endpoints протестовані та доступні
- ✅ Чітке розуміння мапінгу полів
- ⚠️ Можливі неочікувані edge cases в API
- ⚠️ Можливі зміни в requirements від БА

---

### 2.4. РИЗИКИ ТА МІТИГАЦІЯ

| Ризик | Ймовірність | Вплив | Мітигація |
|-------|-------------|-------|-----------|
| Зміна API Tabletki | Низька | Високий | Early integration testing |
| Незрозуміла бізнес-логіка | Середня | Середній | Regular sync з БА/ПМ |
| Performance issues (великі каталоги) | Середня | Середній | Pagination + batching |
| n8n version обмеження | Низька | Високий | Workarounds або upgrade |
| Credential / auth проблеми | Низька | Середній | Backup credentials |

---

## 📅 3. ПРОПОНОВАНИЙ ПЛАН ВИКОНАННЯ

```
ТИЖДЕНЬ 1: Development (13-17 січня)
├── День 1 (13 січня): Catalog Sync + Stock Sync (50%)
├── День 2 (14 січня): Stock Sync (50%) + Booking Flow (30%)
├── День 3 (15 січня): Booking Flow (70%)
├── День 4 (16 січня): Status Sync + Integration Testing (50%)
└── День 5 (17 січня): Integration Testing (50%) + Bug Fixing

ТИЖДЕНЬ 2: Testing + Deployment (20-24 січня)
├── День 6 (20 січня): Documentation + E2E Testing
├── День 7 (21 січня): Bug Fixing + Performance Tuning
├── День 8 (22 січня): Deployment + Monitoring
└── Delivery: 24 січня 2026
```

---

## ✅ 4. NEXT STEPS

1. **Approval цього ТЗ** від БА/ПМ → **ПОТРІБНО**
2. **Підтвердження термінів** (24 січня OK?) → **ПОТРІБНО**
3. **Створити GitHub Issues** для tracking кожного workflow
4. **Почати розробку** Catalog Sync workflow (перший у черзі)

---

## 📝 5. ІСТОРІЯ ЗМІН

| Дата | Версія | Зміни | Автор |
|------|--------|-------|-------|
| 2026-01-12 | 1.0 | Початкова версія після уточнень з БА | AI Analysis |
| 2026-01-12 | 1.0.1 | Re-created after accidental deletion | AI Analysis |

---

**Документ готовий до використання для планування та розробки.**
