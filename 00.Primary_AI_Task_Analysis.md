# Аналіз завдання та підготовка до реалізації

Проведено детальний аналіз завдання від бізнес-аналітика. Нижче представлені результати у двох частинах. 

---

## **Частина 1: Аналіз повноти завдання та критичні запитання**

### **1. 1. Оцінка повноти завдання**

Завдання містить детальну бізнес-логіку, структуру флоу та опис інтеграційних процесів.  Однак для початку розробки **критично бракує технічних деталей** у наступних областях:

#### **Критичні пропуски:**

1. **Автентифікація та credentials:**
   - Не вказано формат Basic Auth для Tabletki (потрібен username/password або token?)
   - Чи потрібні додаткові headers (API keys, authorization tokens)?
   - Де зберігаються credentials у n8n (environment variables, vault)?

2. **Ідентифікатори та мапінг:**
   - `branchID:  30639` - це тестовий чи продуктивний ID? 
   - Як формується `Code` товару в Odoo?  Це `product. id` чи окреме поле?
   - Яке поле Odoo відповідає за `SupplierCodes. Code` (баркод)?
   - Поле `Dr Brand Value ID` - це related field чи computed?  Яка модель?

3. **Тригери статусів в Odoo:**
   - "Зміна статусу повинна тригернути запит" - це потребує **webhook** чи **polling**?
   - Чи є в Odoo автоматичний механізм (automated action, server action)?
   - Якщо polling - яка частота перевірки статусів?

4. **Обробка помилок та retry logic:**
   - Скільки спроб повтору при помилках API?
   - Який timeout для HTTP запитів?
   - Що робити з частково обробленими батчами?

5. **TTN (Транспортна накладна):**
   - Поле `kw_np_tracking_document_name` - це кастомне поле модуля Nova Poshta?
   - Чи завжди є TTN при статусі "Підтверджено"? 
   - Що робити, якщо TTN ще не згенерована?

6. **Структура даних Odoo:**
   - Чи всі товари мають `taxes_id` для VAT calculation?
   - Як обробляти товари з множинними податками?
   - Структура поля `order_line` - це Many2many чи One2many?

---

### **1.2. Запитання до бізнес-аналітика**

#### **Блок A: Автентифікація та доступи**

**A1.** Надайте тестові credentials для: 
   - Odoo (login, password, database name, URL)
   - Tabletki API (login, password або API token)
   - Email для нотифікацій (SMTP settings)

**A2.** Чи є різниця між test та production endpoints для Tabletki? 
   - Test:  `testenv-import.tabletki.ua` → Production: ? 
   - Який `branchID` буде у prod? 

**A3.** Чи потрібна двофакторна автентифікація або IP whitelisting? 

---

#### **Блок B:  Мапінг даних та ідентифікатори**

**B1.** Підтвердіть мапінг полів для **Catalog flow**:
   ```
   Odoo Field               → Tabletki Field
   ─────────────────────────────────────────
   product.product. id       → Offers.Code
   product.product.name     → Offers.Name
   product.product.barcode  → SupplierCodes.Code
   Dr Brand Value ID        → Offers. Producer (format: "Brand:  X")
   taxes_id                 → Offers. VAT (20 або 7)
   ```
   Чи правильно? 

**B2.** Поле `Dr Brand Value ID`:
   - Яка повна назва поля в Odoo?  (напр., `x_studio_dr_brand_value_id`)
   - Це поле типу Many2one на модель `product.brand`?
   - Як отримати текстове значення бренду?

**B3.** Для `SupplierCodes.ID`:
   - Чому використовується значення `"Barcode"`?  Це константа чи змінна?
   - Якщо баркод відсутній - що передавати?

---

#### **Блок C: Статуси та тригери**

**C1.** **Booking flow - створення ордеру:**
   - Поле `origin` в `sale.order` - як воно заповнюється?
   - Чи потрібно створювати `res. partner` (контакт) або завжди `TABLETKI_PARTNER_ID = 184588`?
   - Що робити з полем `customer` (ім'я клієнта з Tabletki)?

**C2.** **Trigger на зміну статусу:**
   - Для кроку "Підтверджено → Готово до відправки": 
     - Який саме action в Odoo тригерить це?  (кнопка Confirm?)
     - State в Odoo: `draft → sale` чи інший?
   - Чи потрібен automated action в Odoo або n8n робить polling?

**C3.** **48 годин для самовивозу:**
   - Після якого саме статусу починається відлік?  (4.0 "Обработано"?)
   - Чи є поле `dateTimeCreated` в Odoo для обчислення? 
   - Хто відповідає за автоскасування - n8n чи Tabletki?

---

#### **Блок D: Обробка даних та крайові випадки**

**D1.** **Stock & Prices flow:**
   - Якщо `qty_available = 0` - чи відправляти такі товари?
   - Фільтр зараз:  `Qty available > 0` - чи правильно? 

**D2.** **Часткове підтвердження (TC-02):**
   - Як в Odoo позначити, що рядок замовлення частково підтверджено? 
   - Чи потрібно створювати окремі `sale.order.line` або змінювати `product_uom_qty`?

**D3.** **Відмова замовлення:**
   - Статус 7 "Скасовано" - чи потрібно передавати `cancelReason` з Odoo?
   - Якщо так - де в Odoo зберігається причина?

**D4.** **TTN обробка:**
   - Чи можлива ситуація, коли TTN змінюється після відправки?
   - Чи потрібен механізм дедуплікації (не відправляти той самий TTN двічі)?

---

#### **Блок E: Технічна інфраструктура**

**E1.** **n8n інстанс:**
   - Self-hosted чи n8n Cloud?
   - Версія n8n? 
   - Чи є обмеження на execution time (timeout)?

**E2.** **Логування та моніторинг:**
   - Куди писати лоґи?  (n8n execution logs, external system, файл?)
   - Яка політика збереження логів? 
   - Чи потрібен Sentry / error tracking?

**E3.** **Rate limits Tabletki API:**
   - Яка максимальна кількість запитів на хвилину/годину?
   - Чи потрібен throttling в n8n?

---

#### **Блок F: Тестування**

**F1.** Чи є підготовлені тестові дані в Odoo: 
   - Товари з тегом `tabletki` ✓
   - Тестові замовлення з різними статусами ✓
   - Різні сценарії VAT (20% та 7%) ✓

**F2.** Критерії acceptance для кожного флоу - чи можна отримати конкретні приклади: 
   - JSON payload для тестового товару (Catalog)
   - Приклад відповіді Tabletki з помилкою
   - Тестове замовлення з частковим підтвердженням

---

### **1.3. Рекомендації щодо уточнень**

**Високий пріоритет (блокують розробку):**
- Credentials та доступи (A1-A3)
- Точний мапінг полів Odoo → Tabletki (B1-B3)
- Механізм тригерів статусів (C1-C3)

**Середній пріоритет (впливають на архітектуру):**
- Обробка помилок та retry (D1-D4)
- Rate limits та інфраструктура (E1-E3)

**Низький пріоритет (можна уточнити під час тестування):**
- Деталі тест-кейсів (F1-F2)

---

## **Частина 2: Оцінка часу реалізації**

### **2.1. Декомпозиція робіт**

| **Етап** | **Завдання** | **Складність** | **Час (год)** |
|----------|--------------|----------------|---------------|
| **1. Підготовка** | | | **6-8** |
| 1.1 | Налаштування n8n credentials (Odoo, Tabletki, Email) | Низька | 1-2 |
| 1.2 | Тестування доступів до API (GET запити) | Низька | 1 |
| 1.3 | Створення тегів в Odoo (`tabletki` для products та orders) | Низька | 1 |
| 1.4 | Підготовка тестових даних (10-15 товарів з різними параметрами) | Середня | 2-3 |
| 1.5 | Налаштування error handling template (base error flow) | Низька | 1-2 |
| **2. Catalog Flow** | | | **10-14** |
| 2.1 | Schedule Trigger (cron 3: 00 AM) | Низька | 0.5 |
| 2.2 | Odoo Node:  Get products з фільтрами | Середня | 2-3 |
| 2.3 | Code Node: VAT calculation (taxes_id → 20/7/0) | Середня | 2-3 |
| 2.4 | Code Node: Transform to Tabletki structure (Offers array) | Висока | 3-4 |
| 2.5 | HTTP Request: POST /Import/Ref/{branchID} | Низька | 1 |
| 2.6 | If Node + Email: Error validation | Низька | 1-2 |
| 2.7 | Тестування з різними сценаріями (20+ товарів, помилки) | Середня | 2-3 |
| **3. Stock & Prices Flow** | | | **6-8** |
| 3.1 | Schedule Trigger (hourly) | Низька | 0.5 |
| 3.2 | Odoo Node: Get qty_available, lst_price | Низька | 1 |
| 3.3 | Code Node: Transform to Rests structure | Середня | 2-3 |
| 3.4 | HTTP Request: POST /Import/Rests | Низька | 1 |
| 3.5 | Error handling | Низька | 1 |
| 3.6 | Тестування (зміна цін/залишків в Odoo) | Низька | 1.5-2 |
| **4. Booking with Delivery** | | | **20-28** |
| **4.1 Створення ордеру** | | | **8-12** |
| 4.1.1 | Schedule Trigger (every 5 min) | Низька | 0.5 |
| 4.1.2 | HTTP Request: GET /api/orders/{branchID}/0 | Низька | 1 |
| 4.1.3 | Code Node: Transform booking → Odoo sale. order format | Висока | 4-6 |
| 4.1.4 | HTTP Request: POST /jsonrpc (create sale. order) | Середня | 2-3 |
| 4.1.5 | Merge + If:  Error handling | Низька | 1-2 |
| 4.1.6 | HTTP Request: Update Tabletki status → 2 (Отримано) | Низька | 0.5-1 |
| **4.2 Статус Ready for Delivery** | | | **8-12** |
| 4.2.1 | Schedule Trigger (every 5 min) | Низька | 0.5 |
| 4.2.2 | Odoo Node: Get orders with state=sale/cancel + tag=tabletki | Низька | 1 |
| 4.2.3 | Switch Node: Route by state | Низька | 1 |
| 4.2.4 | Branch 1 (canceled): Prepare payload + POST status 7 | Середня | 2-3 |
| 4.2.5 | Branch 2 (sale): Get order lines (Odoo Node) | Низька | 1 |
| 4.2.6 | Merge Node:  Combine order + lines | Низька | 1 |
| 4.2.7 | Code Node:  Prepare status 4 payload with rows | Висока | 3-4 |
| 4.2.8 | HTTP Request: POST status 4 to Tabletki | Низька | 0.5-1 |
| **4.3 TTN відправка** | | | **4-6** |
| 4.3.1 | Schedule Trigger (every 5 min) | Низька | 0.5 |
| 4.3.2 | Odoo Node: Get orders з TTN (kw_np_tracking_document_name) | Низька | 1 |
| 4.3.3 | HTTP Request: POST /api/Orders/ttnForOrder | Низька | 1 |
| 4.3.4 | Дедуплікація (не відправляти TTN повторно) | Середня | 2-3 |
| 4.3.5 | Тестування | Низька | 1 |
| **4.4 Скасування клієнтом** | | | **6-8** |
| 4.4.1 | Schedule Trigger (every 5 min) | Низька | 0.5 |
| 4.4.2 | HTTP Request: GET /api/Orders/cancelledOrdersByCustomer | Низька | 1 |
| 4.4.3 | Odoo Node: Get order ID by origin | Низька | 1 |
| 4.4.4 | HTTP Request: POST /jsonrpc action_cancel | Середня | 2-3 |
| 4.4.5 | Merge + HTTP:  Confirm cancellation to Tabletki | Низька | 1-2 |
| 4.4.6 | Тестування | Низька | 1 |
| **5. Самовивіз Flow** | | | **12-16** |
| 5.1 | Створення ордеру (аналогічно 4.1, але без delivery fields) | Середня | 4-6 |
| 5.2 | Статус 2 → 4 (Confirm в Odoo) | Середня | 3-4 |
| 5.3 | Статус 4 → 6 (Done в Odoo) | Середня | 3-4 |
| 5.4 | Автоскасування через 48 год (TC-07) | Висока | 4-6 |
| 5.5 | Тестування всіх сценаріїв | Середня | 2-3 |
| **6. Тестування та документація** | | | **12-16** |
| 6.1 | Виконання всіх test cases (TC-01 до TC-10) | Висока | 6-8 |
| 6.2 | Фіксація багів та доопрацювання | Середня | 4-6 |
| 6.3 | Документація флоу (screenshots, описи нод) | Низька | 2-3 |
| **7. Буфер на непередбачене** | | | **8-12** |
| | API issues, зміни вимог, додаткові уточнення | | 8-12 |

---

### **2.2. Підсумкова оцінка**

| **Сценарій** | **Оцінка (годин)** | **Днів (8-год день)** | **Тижнів** |
|--------------|--------------------|-----------------------|------------|
| **Оптимістичний** (все працює з першого разу) | 66 | 8.25 | **2 тижні** |
| **Реалістичний** (типові проблеми з API, уточнення) | 92 | 11.5 | **2. 5-3 тижні** |
| **Песимістичний** (значні зміни вимог, проблеми з інфраструктурою) | 118 | 14.75 | **3-4 тижні** |

---

### **2.3. Критичний шлях**

1. **Отримання доступів** (блокує все) → 1 день
2. **Catalog + Stock флоу** (базова інтеграція) → 3-4 дні
3. **Booking створення** (найскладніший мапінг) → 4-5 днів
4. **Статуси та TTN** (залежить від п.3) → 3-4 дні
5. **Тестування + фікси** → 2-3 дні

---

### **2.4. Ризики, що впливають на терміни**

| **Ризик** | **Вплив** | **Мітигація** |
|-----------|-----------|---------------|
| Відсутність доступів до Odoo/Tabletki | +3-5 днів | Запросити негайно (A1) |
| Зміна структури API Tabletki | +2-4 дні | Використовувати Swagger для валідації |
| Потреба в кастомних полях Odoo | +1-3 дні | Уточнити структуру БД (B2) |
| Rate limits API не задокументовані | +1-2 дні | Реалізувати експоненційний backoff |
| Automated actions в Odoo потребують розробки | +3-5 днів | Використовувати polling як fallback |

---

### **2.5. Рекомендації щодо послідовності**

**Фаза 1 (Proof of Concept) - 3-5 днів:**
- Catalog Flow (без error handling)
- Stock & Prices Flow
- Базове тестування з 5-10 товарами

**Фаза 2 (Core Booking) - 5-7 днів:**
- Створення ордеру з Tabletki
- Статуси 0 → 2 → 4
- TTN відправка

**Фаза 3 (Edge Cases) - 4-6 днів:**
- Скасування клієнтом
- Самовивіз з таймаутом
- Всі тест-кейси

**Фаза 4 (Production Ready) - 2-3 дні:**
- Error handling + email notifications
- Логування
- Документація

---

### **Остаточна рекомендація:**

**Планувати 3 тижні (15 робочих днів)** з урахуванням:
- 2 дні на уточнення вимог
- 10 днів активної розробки
- 3 дні на тестування та фікси

Якщо всі доступи та відповіді на критичні запитання будуть надані **протягом 1-2 днів**, можливе завершення за **2.5 тижні**. 
