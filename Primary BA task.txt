Мета.
Побудувати універсальну інтеграційну модель між ERP FoodOK (Odoo) та маркетплейсом Tabletki.ua, що забезпечує повний цикл обміну даними для продажу лікарських засобів і може бути повторно використана для підключення інших вендорів у майбутньому.

Цілі.
Забезпечити актуальність товарного каталогу, цін та залишків на стороні маркетплейсу відповідно до даних Odoo.
Скоротити обсяг ручних операцій і залежність від людського фактора в процесах обміну даними.
Підвищити якість обслуговування клієнтів за рахунок коректної та своєчасної обробки бронювань і доставок.
Підтримати зростання обсягів операцій без пропорційного збільшення операційних витрат.
Ресурси та результати.
Ресурси
РезультатиЛюдські: бізнес-аналітик/інтеграційний розробник (n8n), представник foodok, представник Tabletki
Технічні: Odoo ERP, n8n, API Tabletki, тестове та продуктивне середовище
Організаційні: регламенти обміну даними, тестові сценарії, документація

API Tabletki - link
Tabletki swagger - link 
odoo external API - link 
У межах завдання реалізовано та задокументовано чотири інтеграційні флоу:

Catalog

Забезпечує передачу та актуалізацію товарного каталогу з Odoo до маркетплейсу.
Stock & Prices

Забезпечує регулярну синхронізацію складських залишків і цін відповідно до даних Odoo.
Booking with Delivery

Забезпечує приймання бронювань / замовлень з доставкою з маркетплейсу та їх коректне створення в Odoo.
Самовивіз
Замовлення резервується користувачем. Клієнт заберає його приїхавши в офіс
Флоу реалізовані в n8n, протестовані та готові до використання в продуктивному середовищі.
Уніфікована архітектура для повторного використання

Готовність до підключення нових вендорів

Рамки та межі.
РамкиМежіПроєкт охоплює лише інтеграцію FoodOK ↔ Tabletki через API та n8n, що включає:
Аналіз вимог до обміну даними.
Проєктування структури інтеграційних флоу.
Реалізація флоу в n8n.
Мапінг та трансформація даних між системами.
Обробка технічних відповідей API.
Документування реалізованого рішення.


Зміна бізнес-логіки або моделей даних на стороні Odoo.
Розробка або зміна користувацького інтерфейсу як на стороні odoo так і на стороні tabletki.
Побудова аналітичної або фінансової звітності, репортів, тощо.
Розробка додаткових інтеграцій, не описаних у цьому завданні(e.g. Бронь від страхових компаній, Бронь зі знижкою)

Етапи виконання.
Етап 1. Підготовка та узгодження

Узгодити з Замовником перелік сценаріїв, що покриваються інтеграцією (Catalog, Stock & Prices, Booking with Delivery, Самовивіз).
Підтвердити перелік полів для мапінгу (ідентифікатори, коди товарів, ціни, кількості, статуси).
Узгодити правила обробки замовлень/броней (повне/часткове підтвердження, частковий викуп, відмови та причини).
Перевірити наявність доступів до Odoo, n8n, API маркетплейсу, а також тестового середовища.
Етап 2. Проєктування інтеграційних флоу

Спроєктувати логіку кожного флоу, точки входу/виходу, структуру payload та обробку помилок.
Визначити правила ідентифікації сутностей (товар/замовлення/рядок) між системами.
Визначити механізм логування та критерії критичних/некритичних помилок.
Етап 3. Реалізація

Реалізувати отримання товарних даних з Odoo (відбір активних позицій).
Реалізувати отримання залишків та цін з Odoo відповідно до погоджених правил.
Реалізувати приймання бронювань/замовлень з маркетплейсу з доставкою та на самовивіз
Етап 4. Тестування 

Підготувати тестові дані (товари, залишки, ціни, шаблони броней).
Виконати тест-кейси за погодженими сценаріями (включно з причинами відмов).
Зафіксувати результати тестування (статуси, лог-файли, приклади payload/response).
Усунути дефекти та повторити контрольні прогони.
Етап 5. Підготовка до запуску та передача результатів

Узгодити параметри продуктивного запуску (розклади, ліміти, правила повторів).
Підготувати фінальну документацію: опис флоу, мапінги, ключові параметри, опис статусів і помилок.
Передати рішення в підтримку (контакти відповідальних, правила моніторингу, типові інциденти).
6️⃣ 6.1. Аналіз поточного стану 

Бізнес-потреби
На поточний момент компанія FoodOK має потребу в присутності на маркетплейсі Tabletki.ua як одному з ключових каналів онлайн-продажів фармацевтичної продукції. Бізнес зацікавлений у збільшенні обсягів продажів, розширенні охоплення клієнтів та підвищенні швидкості обробки замовлень.
Водночас існує критична потреба:

-уникнути ручної обробки даних (каталогу, цін, залишків, замовлень);
-мінімізувати операційні помилки;
-забезпечити контроль та прозорість статусів замовлень;
-зберегти Odoo як основну систему управління бізнесом

Можливості та процеси

До початку завдання обмін даними був здійснений через інший connector який потребує технічної підтримки.
Технології та інфраструктура

Odoo використовується як основна ERP-система, але не має прямої автоматизованої інтеграції з маркетплейсом.
n8n може бути розгорнуто як інстанс під замовника, так і на стороні quickdo при використанні вендором на основі підписки.
Бізнес-архітектура

Маркетплейс не був інтегрований у єдиний ланцюг управління даними. 
Внутрішні активи
Наявні внутрішні активи:

структурований каталог товарів;
налаштовані склади та ціноутворення;
сформовані бізнес-процеси продажу;
команда, що володіє експертизою в Odoo.
Обмеження активів:

відсутність повторно використовуваних інтеграційних рішень;
мінімальна документація інтеграцій;
рішення мають локальний, а не платформений характер.

6️⃣ 6.2. Визначення майбутнього стану 
Цілі та цільові показники бізнесу
Майбутній стан передбачає створення стабільної, масштабованої та повторно використовуваної інтеграційної платформи між ERP FoodOK (Odoo) та маркетплейсом Tabletki.ua.
Ключові цілі:

Повна автоматизація обміну даними між FoodOK та Tabletki без ручного втручання.
Скорочення часу обробки замовлень до мінімально можливого (near real-time).
Забезпечення єдиного джерела істини (single source of truth) — Odoo.
Створення універсальної архітектури, яка дозволяє підключати нових вендорів до Tabletki з мінімальними доопрацюваннями.
Зниження операційних ризиків і людського фактору.
Цільові показники:

100% замовлень з Tabletki обробляються автоматично.
100% актуальність цін та залишків у Tabletki.
Можливість підключення нового вендора без зміни базової логіки флоу.
Склад простору рішення
Майбутній стан охоплює такі логічні компоненти рішення:

ERP Odoo (FoodOK)

Центральна система управління товарами, цінами, залишками, замовленнями та статусами.
Інтеграційний шар (n8n)

Незалежний, модульний шар оркестрації, який:
ізолює бізнес-логіку від API Tabletki;
дозволяє швидко адаптуватися до змін;
забезпечує повторне використання флоу.
API Tabletki.ua

Зовнішня система, що споживає стандартизовані дані та повертає події (бронювання, статуси, доставки).
Інтеграційні флоу:
Catalog — синхронізація номенклатури.
Stock & Price — регулярне оновлення залишків і цін.
Booking with Delivery — бронювання з доставкою.
Самовивіз — бронювання без доставки.
Обмеження
Формати та правила обміну визначаються API Tabletki.
Неможливість впливати на внутрішню логіку маркетплейсу.
Обмеження частоти викликів API (rate limits).
Залежність від стабільності зовнішнього сервісу.
Організаційна структура та культура
У майбутньому стані:

Інтеграція не залежить від конкретної людини (мінімізація bus factor).
Є чітке розмежування відповідальності:
бізнес — за дані та процеси;
ІТ — за стабільність інтеграції;
інтеграційний шар — за трансформацію даних.
Рішення документоване та стандартизоване.
Можливості та процеси
Після впровадження:

Каталог, ціни та залишки автоматично публікуються в Tabletki.
Замовлення з Tabletki автоматично створюються в Odoo.
Статуси замовлень, відмови, часткові викупи та доставки синхронізуються без ручних дій.
Підтримуються різні сценарії продажу (доставка / самовивіз).
Процеси однакові для всіх майбутніх вендорів.
Технології та інфраструктура
Odoo як ядро бізнес-логіки.
n8n як low-code / integration-platform:
cron-тригери;
обробка помилок;
трансформація JSON;
масштабування флоу.
REST API, JSON, HTTP(S).
Логування та контроль виконання флоу.
Бізнес-архітектура
Майбутня архітектура є:

модульною;
подійно-орієнтованою;
vendor-agnostic.
Кожен вендор підключається через:

однакову логіку флоу;
конфігураційні параметри (ID, коди, правила);
без копіювання логіки з нуля.
Внутрішні активи
У результаті створюються:

стандартизовані інтеграційні флоу;
шаблони трансформації даних;
документація;
тест-кейси;
напрацьований досвід інтеграції з маркетплейсами.
Ці активи можуть бути повторно використані в інших проєктах.

Виявлення припущень
Дані в Odoo структуровані та підтримуються в актуальному стані.
Нові вендори мають схожу модель бізнес-процесів.
Tabletki не змінює критично API без перехідного періоду.
Обсяги навантаження прогнозовані.
Потенційна цінність
Швидке масштабування бізнесу.
Зменшення операційних витрат.
Підвищення якості сервісу для кінцевого клієнта.
Конкурентна перевага завдяки швидкому підключенню нових партнерів.
Формування довгострокового інтеграційного активу, а не разового рішення.
​6️⃣ 6.3. Оцінка ризиків.
Основні ризики

некоректний мапінг даних;
технічні обмеження API;
збої виконання флоу.
Стратегії реагування

логування та контроль помилок;
тестові та контрольні запуски;
повторні спроби (retry) для критичних операцій.
6️⃣ 6.4. Визначення стратегії зміни
GAP-аналіз

Поточний стан: відсутній обмін даними. Здійснена реалізація foodOK - tabletki через інший інтеграційний модуль, з якого можна перевикористати досвід.

Майбутній стан: автоматизовані інтеграційні флоу.
Стратегія зміни

Інкрементальна: реалізація та запуск усіх флоу одночасно.
Перехідні стани

Тестове середовище → продуктивне середовище після валідації результатів.


7.1. Специфікація та моделювання вимог

Зміни на стороні одоо:
1. Створити тег(additional_product_tag_ids) tabletki. Цей тег створюється в моделі product.product(тобто стосується продукту) для того щоб усі продукти які виставляються в каталог Таблеткі можна було ідентифікувати.
2. Створити тег(tag_ids) tabletki. Цей тег належить моделі sale.orders, і допомагає ідентифікувати ордери створені через таблетки. після створення тегу йому присвоюється ID, відповідно щоб використовувати його в флоу треба посилатись саме на ID а не на назву тегу. наприклад tag_ids=19(а не tag_ids=tabletki).

n8n Credentials
1. Одоо юзер - (basic auth - login and password), використовується в конфігураціях усіх одоо нод
2. Таблеткі юзер(basic auth - login and password), використовується в конфігураціях усіх http request нод де ми звертаємось на tabletki



Catalog
В рамках цього флоу відбувається передача товарів з одоо в tabletki для того щоб на стороні tabletki було створено оффери на основі товарів.
Tabletki отримавши товари, перевіряє чи є такі товари в них в каталозі, якщо так, то створює відповідний офер, і як наслідок користувач знайшовши на таблеткі товар в пошуку бачить серед переліку тих в кого можна замовити також оффер контрагента який за допомогою флоу Catalog загрузив товари на tabletki.
Процес працює таким чином що кожен день відправляється оновлений список товарів з одоо. Відповідно таблеткі бачить різницю з попередньою версією каталогу, та створює нові оффери(або видаляє існуючі).

крокконфігураціяoutputкоментартригер
trigger node

Trigger Interval - Days
Days between triggers - 1
Trigger at hour - 3a.m.-раз на день о 3 ночі тригериться процес2. отримати продукти з одооodoo node

Модель - Product Variant
Get Many
Options(Barcode, Name, Taxes Id, Dr Brand Value ID, Id) 
це поля які ми хочемо отримати по кожному продукт варіанту
Filters(Additional Product Tag Ids=tabletki; Dr Brand Value ID != empty) 
таким чином ми відсіюємо усі продукт варіанти в яких немає тегу tabletki, а також ті в яких незаповено поле бренд. {"id":3043,"barcode":"0689FFRR-09","name":"Супи (поштучно) 1 пакет","taxes_id":[34],"dr_brand_value_id":[317,"Brand: Nature's Way"]}


запит в одоо щоб отримати список з усіх продуктів які є, та проходять фільтр - наявність тегу "таблеткі"3. підготувати пейлоадtwo code nodes and one set node


Run once for all items[{"Offers":[{"Code":"3043","Name":"Супи (поштучно) 1 пакет","Producer":"Brand: Nature's Way","VAT":20,"SupplierCodes":[{"ID":"Barcode","Code":"0689FFRR-09"}]}]}]

цей крок розділений на 3 ноди,
1 нода дістає конкретне значення (наприклад 20 або 7) на основі taxes_id. це значення - по суті є відсотком податку.
2 нода підготовлює оффер згідно тієї структури яку очікує таблеткі. тобто перелік товарів перетворюється вже на перелік офферів.
3 нода до цього переліку офферів додає масив "suppliers" тобто вказує якій аптеці(контрагенту) належать ці оффери.4. відправити пейлоад в Tabletkihttp request node

method- post
url - https://testenv-import.tabletki.ua/Import/Ref/30638 де 30638 це бренчІД контрагента в таблеткі.
header: Content-Type application/json

body: {{ JSON.stringify($json) }}
тобто джейсон з інпуту 
[{"IsError":false,"ErrorMessage":"","OffersCount":11,"IsSupplierError":false,"SupplierMessage":"","SuppliersCount":1,"OffersWithSupplierCodesCount":11}]

відправляється масив з офферами на спеціальний едпоніт Таблеткі5. Валідація відповідіIf node

якщо поле isError false то все добре, йдемо шляхом Б
якщо поле isError not false то це помилка, йдемо шляхом Апросто копіюється інпутвалідуємо результат відправки, щоб у випадку помилки можна було нотифікувати менеджера одоо. флоу далі йде або в гілку A(якщо помилка) або в гілку Б(якщо немає помилки)5a. Повідомити на пошту про помилкуgmail node

operation - Send
subject - test Failed to update catalog for Tabletki
Message - джейсон з інпуту
у відповідь на попередній крок таблекті присилає error message у випадку помилки, відповідно цей меседж відправляється email повідомленням на вказану пошту

також попередньо в розділі credentials необхідно створити креди поштової скриньки з якої будуть відправлятись повідомлення.5б. пусто

нічого не відбувається




документація Tabletki: https://docs.tabletki.ua/Html/Index?fileName=0c205f28-6c17-475d-8a80-34d9859160e6



Stock&Prices
Процес передбачає передачу актуальних цін та залишків на tabetki для того щоб таблеткі підтримував актуальність свого каталогу. 
Кожну годину на таблеткі відправляється ціна та qty кожного товару.


крокконфігураціяoutputкоментартригер
trigger node

Trigger Interval - hours
Hours between triggers - 1

-кожну годину тригериться процес2. отримати ціни та залишки з одооodoo node

Модель - Product Variant
Get Many
Options(qty available, lst price, Id) 
Filters(Additional Product Tag Ids=tabletki; Qty available > 0)[{"id":3043,"qty_available":3,"lst_price":1}]


запит в одоо щоб отримати список з усіх продуктів з ціною та залишком(qty) 
та проходять фільтр - наявність тегу "таблеткі"3. підготувати пейлоадcode node

Run once for all items{"Branches":[{"Code":"30639","Rests":[{"Code":"3043","Price":1,"Qty":3,"PriceReserve":1}]}],"DateTime":"16.12.2025 15:11:48"}


на цьому етапі здійснюється трансформація даних. тобто дані з того формату в якому були отримані з одоо трансформуються в той формат який зручний для таблеткі

наприклад дані з поля qty_available вставляються в поле qty
ціна(lst_price) популейтиться в два поля Price та PriceReserve4. відправити пейлоад в Tabletkihttp request node

method- post
url - https://testenv-import.tabletki.ua/Import/Rests 
header: Content-Type application/json

body: {{ JSON.stringify($json) }}
тобто джейсон з інпуту 
[{"IsError":false,"ErrorMessage":"","BranchResults":[{"BranchID":"30639","IsError":false,"ErrorMessage":"","RestCount":11,"SocialProgramsCount":0,"OffersWithSocialProgramPricesCount":0}]}]


по кожному товару відправляються ціни та залишки.

як таблеткі розуміє за по якому саме товаре прийшли ціни? - за рахунок поля Code. в рамках попереднього флоу Catalog було відправлено поле Code до кожного товару(product_id в одоо)5. Валідація відповідіIf node

якщо поле isError false то все добре, йдемо шляхом Б
якщо поле isError not false то це помилка, йдемо шляхом Апросто копіюється інпутвалідуємо результат відправки, щоб у випадку помилки можна було нотифікувати менеджера одоо. флоу далі йде або в гілку A(якщо помилка) або в гілку Б(якщо немає помилки)5a. Повідомити на пошту про помилкуgmail node

operation - Send
subject - test Failed to update catalog for Tabletki
Message - джейсон з інпуту
у відповідь на попередній крок таблекті присилає error message у випадку помилки, відповідно цей меседж відправляється email повідомленням на вказану пошту

також попередньо в розділі credentials необхідно створити креди поштової скриньки з якої будуть відправлятись повідомлення.5б. пусто

нічого не відбувається




документація Tabletki -  https://docs.tabletki.ua/Html/Index?fileName=7ede1d7b-a8d0-4e35-8031-c5d6a61539eb



Бронювання з доставкою
Клієнт оформлює бронювання з доставкою на сайті таблеткі
1. Для того щоб бронювання було можливим зі сторони клієнта - Талеткі вмикають для вендора функцію "Бронювання з доставкою".
2. Далі коли клієнт знаходить товар і натискає "Замовити з доставкою" - форма пропонує введення усіх необхідних даних для доставки.
3. Клієнт заповнює форму.
на стороні одоо:
1. Кожні 5хв одоо запитує в таблеткі чи не зявились нові замовлення(/api/Orders/{branchID}/{statusStr})
2. Якщо у відповідь приходить замовлення, то одразу з детялями які клієнт вказав в формі. Тобто є вже все необхідне щоб замовлення оформити. Відповідно створюємо замовлення в одоо.
3. Далі менеджер оддо підтверджує замовлення(телефонує клієнту уточню деталі, телефонує на склад уточнює наявність і т.п.)
4. Далі клієнт в одоо змінює статус на "Підверджено" 
5. Зміна статусу повинна тригернути запит на таблеткі(Post/api/Orders)
ціль якого - сповістити про зміну статусу замовлення на "4.10 Готово до відправки". 
це потрібно для того щоб таблеткі могли в кабінеті клієнта оновити дані по замовленню

Якщо клієнт не підтвердив замовлення то треба сповістити таблеткі - Post/api/Orders - statusID 7
Це стосується також випадків коли клієнт відмінив замовлення по якійсь іншій причині.

6. Далі вендор відправляє замовлення - генерує ТТН, і згенерований ТТН необхідно також передати в таблеткі(/api/Orders/ttnForOrder)

Також клієнт може скасувати замовлення в кабінеті таблеткі ще до того як з ним звязався вендор для підвердження.
Щоб отримати про це інформацію - необхідно побудувати процес - запитувати кожні 5 хв таблеткі чи є відмінені замовлення.
/api/Orders/cancelledOrdersByCustomer/{branchID}


крокконфігураціяoutputкоментарСтворити ордер


тригер
trigger node

Trigger Interval - minutes
Minutes between triggers - 5

-кожні 5 хв тригеряться процес2. запитати в таблеткі чи є нові замовленняHttp request node

method: get
url: https://testenv-reserve.tabletki.ua/api/orders/30639/0
header: Content-Type application/json

no body

[{"id":"52feb5ee-fb46-4efa-83a0-e2c0b0d39f81","code":330438632,"statusID":0,"dateTimeCreated":"2025-12-17T11:33:06","customer":"","customerPhone":"+38 (050) 988-0099","customerEmail":"","comment":"","branchID":"30639","externalNmb":"","docAdditionalInfo":"","customerAdditionalInfo":"","reserveSource":"TabletkiUA","cancelReason":"","rows":[{"goodsCode":"1919","goodsName":"Гіалуронова кислота з вітаміном С (100мг/60мг) Грін Віза","goodsProducer":"Brand: Solaray","qty":2,"price":15,"qtyShip":0,"priceShip":0,"needOrder":0,"additionalInfo":{},"priceType":"","promoId":"","pctFranchise":0,"pctDiscount":0,"estPrice":0,"fixedRefund":0,"medicationRequestID":""}],"deliveryData":[{"key":"DeliveryServiceName","value":"Нова Пошта","description":"Служба доставки"},{"key":"DeliveryServiceAlias","value":"NP","description":"Код служби доставки"},{"key":"FullName","value":"Тестт Тест ","description":"ПІБ отримувача"},{"key":"DeliveryServiceName","value":"Нова Пошта","description":"Оператор доставки"},{"key":"LastName","value":"Тестт","description":"Отримувач (Призвіще)"},{"key":"Name","value":"Тест","description":"Отримувач (Ім'я)"},{"key":"MiddleName","value":"","description":"Отримувач (По-батькові)"},{"key":"CityReceiver","value":"Хмельницький","description":"Місто отримувача"},{"key":"ID_Whs","value":"b4eb3341-4995-11e9-acea-005056b24375","description":"Відділення отримувача"},{"key":"ReceiverWhs","value":"Поштомат \"Нова Пошта\" №3373: вул. Кам'янецька, 19а, Либідь плаза (вхід 2)","description":"Найменування відділення отримувача"}]}]

у відповідь на цей запит таблеткі надають усі замовлення  які належать вендору 30639(branchID - 30639), та мають статус 0, тобто щойно створені користувачем.
В даному прикладі маємо замовлення на 2 упаковки гіалуронової кислоти та багато полів з деталями доставки2. підготовка пейлоадуcode node

Mode - Run once for each item[{"jsonrpc":"2.0","method":"call","params":{"service":"object","method":"execute_kw","args":["test",34,"13e0b44ba4f545a0c9bd39388a354a118e82c4c5","sale.order","create",[{"partner_id":184588,"origin":"52feb5ee-fb46-4efa-83a0-e2c0b0d39f81","client_order_ref":"+38 (050) 988-0099","note":"Tabletki code: 330438632\nPhone: +38 (050) 988-0099\nComment: \n\nDelivery details:\nDelivery service: Нова Пошта\nService alias: NP\nReceiver: Тестт Тест \nLast name: Тестт\nName: Тест\nMiddle name: \nCity: Хмельницький\nWarehouse ID: b4eb3341-4995-11e9-acea-005056b24375\nWarehouse name: Поштомат \"Нова Пошта\" №3373: вул. Кам'янецька, 19а, Либідь плаза (вхід 2)","order_line":[[0,0,{"product_id":1919,"name":"1919 - Гіалуронова кислота з вітаміном С (100мг/60мг) Грін Віза","product_uom_qty":2,"price_unit":15}]],"tag_ids":[[4,19]]}]}]}]


Клієн новий не створюється, натомість підставляється TABLETKI_PARTNER_ID = 184588
що відповідає попередньо створеному в одоо клієнту. тобто всі замовлення що приходять з таблеткі автоматично закріпляються на цього клієнта "Tabletki client"
на цьому кроці інпут з попередньої ноди трансформується в той пейлоад який на наступному кроці буде відправлено в одоо для створення замовлення.

фактично відбувається зміна формату масиву, перейменування полів. обєднання делівері полів в одне поле note

доводимо цей пейлоад до структури яка виpначена в офіційній документації апі одоо
https://www.odoo.com/documentation/19.0/developer/reference/external_rpc_api.html

3. відправка ордеру в одооhttp request node
одоо нода в даному випадку не використовується оскільки має обмеження по конфігурації

method: post
URL: https://test.foodok-17ce.odoo.systems/jsonrpc
header: Content-Type application/json

body: {{ $json }}
тобто просто береться пейлод з попередньої ноди[
  {
    "jsonrpc": "2.0",
    "id": null,
    "result": 8415
  }
]
як наслідок. в одоо створюється ордер, у відповідь по апі одоо відправляє 8415 що є ордер ІД новоствореного ордеру.4. If та MergeIf node 
Condition - {{$json.error}}
Operator - is empty

Merge node
Mode: Choose branch
Number of inputs: 2
Output ype: wait for all inputs to arrive
Output: Data of specific input
Use data of input: 1передає далі аутпут ноди 2. підготовка пейлоадукомбінація нод If та Merge побудована таким чином що якщо ордер було успішно створено то процес іде далі , відповідно якщо ордер в одоо не було створено то процес завершується.2. відправка статусу 2 ОтриманоHttp request node

method: post
url: https://testenv-reserve.tabletki.ua/api/orders
header: Content-Type application/json

body: JSON
бере поля з інпуту та перейменовує їх в ті назви полів які апі таблеткі очікують
https://docs.tabletki.ua/Html/Index?fileName=bb2865c7-a9d9-4e48-90bc-eb307f06fc36
[
  {
    "processedDocs": [
      {
        "id": "52feb5ee-fb46-4efa-83a0-e2c0b0d39f81",
        "result": "Status updated"
      }
    ],
    "description": ""
  }
]
теоретично підготовку пейлоаду можна було реалізувати через code ноду і вже після неї окремо http request нодою просто передати попередньо підготовлений пейлоад. 
але в даному випадку підготовка пейлоаду - лише перейменування назви полів.

цей крок потрібен для того щоб ми могли повідомити таблеткі що букінг який ми забрали зі статусом 0 на кроці1. ми успішно обробили і в наступному запиті на кроці один це саме замовлення вже не зявиться.Створити контакт










Отримати зміни по статусу Ready for Delivery


тригер
trigger node

Trigger Interval - minutes
Minutes between triggers - 5-кожні 5 хв тригеряться процес2. отримати зміни по статусамodoo node

model: Sales Order

Options(id, origin, order line, state)

Filters(state-in-{{ ["sale", "cancel"] }};
 tag ids - 19)

[{"id":8411,"origin":"894a008e-539b-40f0-b495-1e40cc78d026","order_line":[9600],"state":"sale"}]


отримуємо перелік усіх ордерів що існують в одоо в яких стутус sale або cancel для того щоб в наступних кроках сповістити таблеткі про зміну статусу.
також ,як завжди, фільтруємо на наякність тегу - tabletki3. розділення по статусамroute node

шлях 0 - state: sale
шлях 1 - state: canceloutput 0: array перелік підтверджених ордерів
output 1: array перелік скасованих ордеріваррей з ордерами з попереднього кроку розділився на 2 гілки4а.(шлях1)
 підготовка пейлоадуEdit fields node

Mode: data mapping
id to origin
statusID always 7
branchID always 30639[
  {
    "id": "e3438195-2235-49bc-99a0-e627db86af3e",
    "statusID": 7,
    "branchID": "30639"
  }
]
підгот овка пейлоаду перед тим як відправити на таблеткі зміну статусу по замовлення на стутус 7 - Скасовано5а.(шлях1)
відправка зміни статусу на Canceledhttp request node

Method: post
url: https://testenv-reserve.tabletki.ua/api/orders
header: Content-Type application/json


body: json з попередньо підготовленого пейлоаду
[
  {
    "processedDocs": [
      {
        "id": "e3438195-2235-49bc-99a0-e627db86af3e",
        "result": "Order is canceled"
      }
    ],
    "description": ""
  }
]
безпосередньо відправка нового статусу. На стороні Таблеткі ордер теж скасується в кабінеті користувача4б.(шлях0)
отримка деталей по товарам замовленняodoo node

model: sales order line
options(price unit, product uom qty, name, product id)

filters(order id = {{ $json.id }})
тобто фільтруємо таким чином щоб ордер лайн надали лише по ід з інпуту(інпут для цієї ноди береться з кроку 2.)[{"id":9600,"price_unit":126,"product_uom_qty":3,"name":"2399 - Ресвератрол Грін Віза","product_id":[2399,"[01/011] Ресвератрол Грін Віза"]}]

на кроці 2 ми лише отримали ордер ід, а також ід по тим order line які наповнюють цей ордер(тобто сам товар).

тож нам потрібно окремим кроком зробити запит в одоо з orderline ID щоб одоо повернуло нам інформацію(назва товару ціна кількість) ці дані нам потрібні оскільки в подальшому ми хочемо повідомити таблеткі про підтвердження замовлення, відповідно в процесі підтвердження саме зомовлення може змінитись. наприклад кількість одиниць товару збільшили з 2 до 3.5б.(шлях0)
обєднати ордер та ордерлайн

merge node

mode: combine

[{"id_1":8411,"origin_1":"894a008e-539b-40f0-b495-1e40cc78d026","order_line_1":[9600],"state_1":"sale","id_2":9600,"price_unit_2":126,"product_uom_qty_2":3,"name_2":"2399 - Ресвератрол Грін Віза","product_id_2":[2399,"[01/011] Ресвератрол Грін Віза"]}]

нода покликана обєднати пейлоадд здобутий на кроці 2(де є самий ордер)
та пейлоад з кроку 4б де є деталізація по цьому ордеру, тобто які ордер лайн наповнююють цей ордер)6б.(шлях0)
підготовка пейлоадуcode node

JS code код що забезпечує трансформацію полів
а також
сетаються поля statusID=4; branchID=30639[{"id":"894a008e-539b-40f0-b495-1e40cc78d026","statusID":4,"branchID":"30639","rows":[{"goodsCode":2399,"goodsName":"[01/011] Ресвератрол Грін Віза","goodsProducer":"","qtyShip":3,"priceShip":126}]}]

необхідні дані для того щоб повідомити таблеткі про зміну статусу на ready for delivery 4.0 вже зібрані, тому залишилось їх трансформувати в той пейлоад який очікує таблеткі. дана ноде робить саме це.7б.(шлях0)
відправка статусу Ready for Delivery
http request node

method: post
url: https://testenv-reserve.tabletki.ua/api/orders
header: Content-Type application/json

body: json пейлоад з попередньої ноди[
  {
    "processedDocs": [
      {
        "id": "894a008e-539b-40f0-b495-1e40cc78d026",
        "result": "Status updated"
      }
    ],
    "description": ""
  }
]
відправка статусу 4.0Чи зявилась ТТН в замовленні


тригер
trigger node

Trigger Interval - minutes
Minutes between triggers - 5-кожні 5 хв тригеряться процес2. чи є замовлення з ТТНodoo node

model: Sales order
Options(origin, kw np tracking document name)
Filters(tag ids=19, kw np tracking document name != false)[
  {  "id": 8410,  
"origin": "61252c55-80d2-4f2a-8a54-57895a0f27f3",
  "kw_np_tracking_document_name": "20400400614573"
  },
запитуємо в одоо чи є замовлення з тегом tabletki в яких є ТТН.
у відповідь одоо повертає перелік таких замовлень , або нічого(тоді процес далі не йде)3. відправити ТТН в таблеткіhttp request node

method: post
URL: https://testenv-reserve.tabletki.ua/api/Orders/ttnForOrder
header: Content-Type application/json

bode: json
expression - перейменовує поля з інпуту(наприклад origin на id) Для того щоб відповідати стуктурі апі запиту таблеткі[{"processedDocs":[{"id":"61252c55-80d2-4f2a-8a54-57895a0f27f3","result":"TTN number is accepted"},{"id":"e3438195-2235-49bc-99a0-e627db86af3e","result":"Warning: You cannot create TTN"}],"description":""}]

відправляємо ТТН в таблеткі для того щоб користувач міг трекати замовлення через кабінет таблеткіЧи є відміна користувачем


тригер
trigger node

Trigger Interval - minutes
Minutes between triggers - 5-кожні 5 хв тригеряться процес2. чи є відміни користувачемhttp request node

method: GET
url: https://testenv-reserve.tabletki.ua/api/Orders/cancelledOrdersByCustomer/30639
header: Content-Type application/json[
  {
    "id": "52feb5ee-fb46-4efa-83a0-e2c0b0d39f81",
    "branchID": "30639",
    "cancelDateTime": "2025-12-17T13:05:51",
    "cancelReason": "В аптеці інша ціна"
  }
]
запитуємо в таблеткі чи є відмінені користувачем замовлення

у відповідь таблеткі присилає origin замовлення але не id замовлення3. дізнатись ордер ідodoo node

model: sales order
Options(id, origin)
Filters(origin ={{ $json.id }} 
tag ids=19)[
  {
    "id": 8415,
    "origin": "52feb5ee-fb46-4efa-83a0-e2c0b0d39f81"
  }
]
з точки зору структури полів одоо, у попередній відповіді таблеткі присилає origin замовлення але не id замовлення, тому необхідно зробити ще один запит в одоо і дізнатись ордер ід на основі origin4. скасувати замовлення в одооhttp request node

method: post
url: https://test.foodok-17ce.odoo.systems/jsonrpc

body: json
"sale.order",
"action_cancel",
та вказуємо ід замовлення з інпуту
[
  {
    "jsonrpc": "2.0",
    "id": 1,
    "result": true
  }
]
відміняємо замовлення по order ID


5. змерджити пейлоадmerge node

Mode: combine[{"jsonrpc_1":"2.0","id_1":1,"result_1":true,"id_2":8415,"origin_2":"52feb5ee-fb46-4efa-83a0-e2c0b0d39f81"}]

потрібно обєднати аутпути кроків 3 та 4, оскільки атупут лише кроку 4 недостатньо(бо немає поля origin) для того щоб сформувати пейлоад  необхідний на наступному кроці 5. повідомити таблеткі що відміну опрацьованоhttp request node

method: post
url: https://testenv-reserve.tabletki.ua/api/Orders/acceptedCancelledOrdersByCustomer
body: json
expression - взяти origin з інпуту
header: Content-Type application/jsonВідповідь серверу на такий запит буде пустим (лише код відповіді 200).для того щоб наступного разу на кроці 2 таблеткі не віддали ІД вже опрацьованого замовлення, потібно повідомити таблеткі що відміну ми вже опрацювали.

для цього таблеткі зробили спеціальний ендпоінт на який просто очікують ІД(origin в одоо)

Створення контакту
крокdescriptioncomment1Отримали бронювання з Tabletki (разом з даними клієнта та доставки).Це вже відбувається в рамках флоу Бронювання з доставкою, підфлоу Створити ордер, крок 2. запитати в таблеткі чи є нові замовлення.2Перевірили в Odoo, чи існує контакт з таким номером телефону.за допомогою одоо ноди перевіряємо чи є в системі контакт з таким номером телефону3Якщо контакт знайдено — використали існуючий контакт.взяти parter_id цього контакту4Якщо контакт не знайдено — створили новий контакт в Odoo на основі даних з Tabletki.
Контакт позначили як Tabletki (тег).якщо у відповідь на крок 2 пусто - необхідно ще одна оддо нода яка в цей момент тригернеться і створить в одоо контакт на основі даних доставки5Повернули partner_id у флоу створення замовлення.так чи інакше ми повинні повернутись назад у флоу Створити ордер з partner_id(чи щойно створений, чи взятий з бази контактів)6Далі замовлення в Odoo створюється вже з цим контактом.В нинішній реалізації флоу Створити ордер ми створює ордер завжди з одним й тим самим контктом partner_id=184588, потрібно модифікувати флоу атким чином щоб partner_id брався з цього саб-флоу



Самовивіз

Запитали в tabletki чи замовлення зі статусом 0(так само як і флоу замовлення на доставку)
створений ордер в системі одоо. 

після цього в таблеткі має повернутись статус 2. Отримано
Далі менеджер одоо переглянув замовлення, за необхідності сконтактував з клієнтом, та підтвердив замовлення(видозмінивши його за потреби). 
Менеджер підтвердив замомовлення натиснувши confirm. 
8. натискання кнопки має тригернути запит систему таблеткі з оновленням статусу замовлення на 4. Обработано.

Далі на стороні таблеткі замовлення актуальне 48 годин для того щоб клієнт прийшов та забрав його. 
9. Коли клієнт прийшов і забрав - в системі одоо менеджр фіналізує замовлення як Done, що має тригернути запит на таблеткі зі статусом 6 Продаж 
12.13. якщо замовлення на якомусь етапі скасовується - відправляємо Стутус 7







Критерії приймання
Загальні
Усі 4 флоу розгорнуті в n8n, активні та задокументовані.
Флоу працюють без ручного втручання (окрім бізнес-дій менеджера в Odoo).
Помилки логуються, повторні запити не створюють дублікатів.
Дані між Tabletki ↔ n8n ↔ Odoo узгоджені (ID, статуси, кількість, ціни).
Flow 1. Каталог
Каталог успішно передається з Odoo до Tabletki.
Товари мають коректні коди, назви, виробників.
Оновлення не створює дублікатів товарів.
Помилки окремих позицій не зупиняють весь флоу.
Flow 2. Залишки та ціни
Залишки та ціни синхронізуються за розкладом.
Передаються лише актуальні дані.
Нульові залишки коректно обробляються.
Tabletki відображає ті самі значення, що й Odoo.
Flow 3. Створення бронювання (Order → Odoo)
Замовлення зі статусом 0 коректно створюється в Odoo.
В Odoo створений один ордер на одне замовлення.
Після створення в Tabletki повертається статус 2 (Отримано).
Дані рядків (товар, кількість, ціна) відповідають замовленню.
Flow 4. Статуси та фіналізація
Confirm в Odoo оновлює статус в Tabletki на 4 (Оброблено).
Замовлення залишається активним у Tabletki 48 годин.
Статус Done в Odoo тригерить фінальний статус у Tabletki.
Повторні статусні апдейти не ламають логіку.
Бізнес-прийняття
Менеджер може повністю обробити замовлення без технічних дій.
Клієнт може забрати замовлення без розбіжностей у даних.
Замовник підтверджує, що сценарій відповідає реальному процесу.
Документація
Є опис флоу, статусів і відповідальностей.
Є перелік відомих обмежень і точок розширення.


Тест кейси.
Передумови:
Кроки:
Очікуваний результат:
TC-01 — Бронь підтверджена в повному обсязі, здійснено продаж
Є замовлення (бронь) з кількома позиціями, усі позиції доступні в Odoo (кількість достатня).
Інтеграційний флоу Booking with Delivery активний.
Отримати бронь від маркетплейсу (статус “Отримано”).
Виконати підтвердження броні в повному обсязі (усі рядки підтверджені).
Провести продаж усіх позицій (повний викуп).
Передати фінальний статус/результат у маркетплейс (якщо передбачено флоу).
У маркетплейсі бронь має фінальний стан “продано повністю”.
У Odoo створені/оновлені документи продажу з усіма позиціями та правильними кількостями.
Відсутні помилки інтеграції, дані узгоджені між системами.
TC-02 — Бронь підтверджена частково (відсутні декілька товарів), здійснено продаж
Є бронь з кількома позиціями, для частини позицій кількість в Odoo недостатня або відсутня.
Флоу активний.
Отримати бронь (статус “Отримано”).
На етапі підтвердження виконати часткове підтвердження (частині рядків підтвердити qty, частині — 0).
Провести продаж підтверджених позицій.
Передати у маркетплейс підтверджені кількості та фінал продажу.
У маркетплейсі: бронь “підтверджена частково”, продаж виконаний по підтверджених позиціях.
У Odoo: продаж лише по підтверджених товарах, відсутні рядки з “некоректними” qty/цінами.
Статуси та кількості збігаються між системами.
TC-03 — Бронь підтверджена в повному обсязі, продаж здійснено частково (викуплено декілька товарів)
Є бронь з кількома позиціями, усі доступні.
Флоу активний.
Отримати бронь (статус “Отримано”).
Підтвердити бронь повністю (усі рядки підтверджені).
На етапі продажу провести частковий викуп (частину позицій продати, частину — не продати).
Передати у маркетплейс результат продажу (що саме викуплено).
У маркетплейсі: бронь “підтверджена повністю”, але “продаж частковий”.
У Odoo: продаж відображає фактично викуплені позиції.
Непродані позиції не закриваються як продані.
TC-04 — Відмова до формування броні
Є замовлення/запит до створення броні, але бронь ще не сформована.
Флоу активний.
Зафіксувати відмову на етапі до формування броні (на стороні процесу/маркетплейсу).
Передати статус відмови в Odoo (якщо створення документа вже відбулось — оновити його стан).
У маркетплейсі замовлення має статус “відмова до броні”.
В Odoo: або не створено замовлення/бронь, або створений запис переведено у стан “скасовано” без формування резервів/продажу.
Причина відмови зафіксована (якщо передбачено полем).

TC-05 — Відмова після формування броні
Бронь сформована (наприклад, статус “Обработан”).
Флоу активний.
Сформувати бронь та підтвердити її (повністю або частково).
Здійснити відмову після формування броні.
Передати статус відмови та причину в маркетплейс (і/або в Odoo — залежно від напрямку).
У маркетплейсі бронь/замовлення має фінальний статус “відмова після броні”.
В Odoo: резерв/бронь знято, продаж не проведений (або анульований), статус документа узгоджений.
Причина відмови зафіксована.
TC-06 — Відмова споживача (ручна на етапі продажу)
Бронь сформована, доступний етап продажу.

На етапі продажу обрати причину “Відмова споживача”.
Завершити обробку замовлення як відмову.
Замовлення має статус “відмова”, причина = “Відмова споживача”.
В Odoo: документ(и) не переходять у стан “продано”, резерви зняті (за правилами процесу).
TC-07 — Вийшов термін бронювання (автоматично через 48 год + 10 хв після “Обработан”)
Замовлення має статус “Обработан”.
Система/планувальник обробляє TTL бронювання.
Встановити замовленню статус “Обработан”.
Дочекатися настання 48 год 10 хв (або змоделювати час/запуск перевірки).
Перевірити, що відмова проставилась автоматично.
Автоматично встановлено відмову з причиною “Вийшов термін бронювання”.
Статуси синхронізовані між системами, резерви зняті.
TC-08 — Немає рецепту (ручна на етапі продажу)
Є бронь з рецептурним товаром, етап продажу доступний.

На етапі продажу обрати причину “Немає рецепту”.
Завершити як відмову.
Відмова зафіксована, причина = “Немає рецепту”.
В Odoo: відсутній продаж; бронь/резерв закриті коректно.
TC-09 — Не підійшов термін придатності (ручна на етапі продажу)
Є бронь, етап продажу доступний.

На етапі продажу обрати причину “Не підійшов термін придатності”.
Завершити як відмову.
Відмова зафіксована з відповідною причиною.
В Odoo: відсутній продаж; бронь/резерв закриті коректно.
TC-10 — Недостатня кількість (за даними облікової системи) — автоматично після статусу “Отримано” (2.0)
Замовлення отримано (“Отримано”).
В Odoo на момент отримання недостатньо кількості для хоча б однієї позиції.
Отримати замовлення (статус “Отримано”).
Запустити автоматичну перевірку доступності (після отримання).
Перевірити реакцію системи.
Система автоматично формує відмову/часткову відмову за правилом “Недостатня кількість (по даним облікової системи)”.
В Odoo не створюється некоректних резервів/продажів; статуси синхронізовані.

TC-01 — Недостатня кількість (під час комплектації по запиту на бронювання) — після “Обработан” (4.0)
Замовлення в статусі “Обработan”.
На етапі комплектації фактично виявлено нестачу (розбіжність із обліком).
Перевести замовлення в статус “Обработan”.
На етапі комплектації зафіксувати нестачу для частини позицій.
Виконати обробку за правилом “Недостатня кількість (під час комплектації)”.
Замовлення переходить у відмову або часткове підтвердження (залежно від правил), причина зафіксована.
У Odoo: підтверджені/зняті кількості відповідають фактичній комплектації; статуси узгоджені.
